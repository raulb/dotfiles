#!/bin/bash

jq=$(command -v jq)
meroxa=$(command -v /Users/rb/code/meroxa/cli/meroxa)

pipelineName="turbine-pipeline-$1"

cli() {
	meroxa "$@"
}

connectors() {
	cli connectors list --json |\
		jq -r ".[] | select(.pipeline_name == \"$pipelineName\") | .name"
}

functions() {
	cli functions list --json |\
		jq -r ".[] | select(.pipeline.name == \"$pipelineName\") | .name"
}

echo "Deleting functions..."
for c in $(functions); do
	cli functions rm -f $c
done

echo "Deleting connectors..."
for c in $(connectors); do
	cli connectors rm -f $c
done

echo "Deleting pipeline..."
cli pipelines rm -f $pipelineName

echo "Deleting app..."
cli apps rm $1

exit 0